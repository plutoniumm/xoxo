import{C as e,S as t,T as n,_ as r,a as i,b as a,c as o,f as s,g as c,h as l,i as u,l as d,m as f,n as p,o as m,p as h,r as g,s as _,t as v,u as y,v as b,w as x,x as S,y as ee}from"./geometry-BRvmb3pZ.js";var C={type:`change`},w={type:`start`},T={type:`end`},E=new ee,D=new r,O=Math.cos(70*h.DEG2RAD),k=new n,A=2*Math.PI,j={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6},M=1e-6,N=class extends o{constructor(r,i=null){super(r,i),this.state=j.NONE,this.target=new n,this.cursor=new n,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.keyRotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:`ArrowLeft`,UP:`ArrowUp`,RIGHT:`ArrowRight`,BOTTOM:`ArrowDown`},this.mouseButtons={LEFT:s.ROTATE,MIDDLE:s.DOLLY,RIGHT:s.PAN},this.touches={ONE:e.ROTATE,TWO:e.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this._lastPosition=new n,this._lastQuaternion=new b,this._lastTargetPosition=new n,this._quat=new b().setFromUnitVectors(r.up,new n(0,1,0)),this._quatInverse=this._quat.clone().invert(),this._spherical=new t,this._sphericalDelta=new t,this._scale=1,this._panOffset=new n,this._rotateStart=new x,this._rotateEnd=new x,this._rotateDelta=new x,this._panStart=new x,this._panEnd=new x,this._panDelta=new x,this._dollyStart=new x,this._dollyEnd=new x,this._dollyDelta=new x,this._dollyDirection=new n,this._mouse=new x,this._performCursorZoom=!1,this._pointers=[],this._pointerPositions={},this._controlActive=!1,this._onPointerMove=F.bind(this),this._onPointerDown=P.bind(this),this._onPointerUp=I.bind(this),this._onContextMenu=U.bind(this),this._onMouseWheel=z.bind(this),this._onKeyDown=B.bind(this),this._onTouchStart=V.bind(this),this._onTouchMove=H.bind(this),this._onMouseDown=L.bind(this),this._onMouseMove=R.bind(this),this._interceptControlDown=W.bind(this),this._interceptControlUp=G.bind(this),this.domElement!==null&&this.connect(this.domElement),this.update()}connect(e){super.connect(e),this.domElement.addEventListener(`pointerdown`,this._onPointerDown),this.domElement.addEventListener(`pointercancel`,this._onPointerUp),this.domElement.addEventListener(`contextmenu`,this._onContextMenu),this.domElement.addEventListener(`wheel`,this._onMouseWheel,{passive:!1}),this.domElement.getRootNode().addEventListener(`keydown`,this._interceptControlDown,{passive:!0,capture:!0}),this.domElement.style.touchAction=`none`}disconnect(){this.domElement.removeEventListener(`pointerdown`,this._onPointerDown),this.domElement.removeEventListener(`pointermove`,this._onPointerMove),this.domElement.removeEventListener(`pointerup`,this._onPointerUp),this.domElement.removeEventListener(`pointercancel`,this._onPointerUp),this.domElement.removeEventListener(`wheel`,this._onMouseWheel),this.domElement.removeEventListener(`contextmenu`,this._onContextMenu),this.stopListenToKeyEvents(),this.domElement.getRootNode().removeEventListener(`keydown`,this._interceptControlDown,{capture:!0}),this.domElement.style.touchAction=`auto`}dispose(){this.disconnect()}getPolarAngle(){return this._spherical.phi}getAzimuthalAngle(){return this._spherical.theta}getDistance(){return this.object.position.distanceTo(this.target)}listenToKeyEvents(e){e.addEventListener(`keydown`,this._onKeyDown),this._domElementKeyEvents=e}stopListenToKeyEvents(){this._domElementKeyEvents!==null&&(this._domElementKeyEvents.removeEventListener(`keydown`,this._onKeyDown),this._domElementKeyEvents=null)}saveState(){this.target0.copy(this.target),this.position0.copy(this.object.position),this.zoom0=this.object.zoom}reset(){this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this.dispatchEvent(C),this.update(),this.state=j.NONE}update(e=null){let t=this.object.position;k.copy(t).sub(this.target),k.applyQuaternion(this._quat),this._spherical.setFromVector3(k),this.autoRotate&&this.state===j.NONE&&this._rotateLeft(this._getAutoRotationAngle(e)),this.enableDamping?(this._spherical.theta+=this._sphericalDelta.theta*this.dampingFactor,this._spherical.phi+=this._sphericalDelta.phi*this.dampingFactor):(this._spherical.theta+=this._sphericalDelta.theta,this._spherical.phi+=this._sphericalDelta.phi);let r=this.minAzimuthAngle,i=this.maxAzimuthAngle;isFinite(r)&&isFinite(i)&&(r<-Math.PI?r+=A:r>Math.PI&&(r-=A),i<-Math.PI?i+=A:i>Math.PI&&(i-=A),r<=i?this._spherical.theta=Math.max(r,Math.min(i,this._spherical.theta)):this._spherical.theta=this._spherical.theta>(r+i)/2?Math.max(r,this._spherical.theta):Math.min(i,this._spherical.theta)),this._spherical.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this._spherical.phi)),this._spherical.makeSafe(),this.enableDamping===!0?this.target.addScaledVector(this._panOffset,this.dampingFactor):this.target.add(this._panOffset),this.target.sub(this.cursor),this.target.clampLength(this.minTargetRadius,this.maxTargetRadius),this.target.add(this.cursor);let a=!1;if(this.zoomToCursor&&this._performCursorZoom||this.object.isOrthographicCamera)this._spherical.radius=this._clampDistance(this._spherical.radius);else{let e=this._spherical.radius;this._spherical.radius=this._clampDistance(this._spherical.radius*this._scale),a=e!=this._spherical.radius}if(k.setFromSpherical(this._spherical),k.applyQuaternion(this._quatInverse),t.copy(this.target).add(k),this.object.lookAt(this.target),this.enableDamping===!0?(this._sphericalDelta.theta*=1-this.dampingFactor,this._sphericalDelta.phi*=1-this.dampingFactor,this._panOffset.multiplyScalar(1-this.dampingFactor)):(this._sphericalDelta.set(0,0,0),this._panOffset.set(0,0,0)),this.zoomToCursor&&this._performCursorZoom){let e=null;if(this.object.isPerspectiveCamera){let t=k.length();e=this._clampDistance(t*this._scale);let n=t-e;this.object.position.addScaledVector(this._dollyDirection,n),this.object.updateMatrixWorld(),a=!!n}else if(this.object.isOrthographicCamera){let t=new n(this._mouse.x,this._mouse.y,0);t.unproject(this.object);let r=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),this.object.updateProjectionMatrix(),a=r!==this.object.zoom;let i=new n(this._mouse.x,this._mouse.y,0);i.unproject(this.object),this.object.position.sub(i).add(t),this.object.updateMatrixWorld(),e=k.length()}else console.warn(`WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled.`),this.zoomToCursor=!1;e!==null&&(this.screenSpacePanning?this.target.set(0,0,-1).transformDirection(this.object.matrix).multiplyScalar(e).add(this.object.position):(E.origin.copy(this.object.position),E.direction.set(0,0,-1).transformDirection(this.object.matrix),Math.abs(this.object.up.dot(E.direction))<O?this.object.lookAt(this.target):(D.setFromNormalAndCoplanarPoint(this.object.up,this.target),E.intersectPlane(D,this.target))))}else if(this.object.isOrthographicCamera){let e=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),e!==this.object.zoom&&(this.object.updateProjectionMatrix(),a=!0)}return this._scale=1,this._performCursorZoom=!1,a||this._lastPosition.distanceToSquared(this.object.position)>M||8*(1-this._lastQuaternion.dot(this.object.quaternion))>M||this._lastTargetPosition.distanceToSquared(this.target)>M?(this.dispatchEvent(C),this._lastPosition.copy(this.object.position),this._lastQuaternion.copy(this.object.quaternion),this._lastTargetPosition.copy(this.target),!0):!1}_getAutoRotationAngle(e){return e===null?A/60/60*this.autoRotateSpeed:A/60*this.autoRotateSpeed*e}_getZoomScale(e){let t=Math.abs(e*.01);return .95**(this.zoomSpeed*t)}_rotateLeft(e){this._sphericalDelta.theta-=e}_rotateUp(e){this._sphericalDelta.phi-=e}_panLeft(e,t){k.setFromMatrixColumn(t,0),k.multiplyScalar(-e),this._panOffset.add(k)}_panUp(e,t){this.screenSpacePanning===!0?k.setFromMatrixColumn(t,1):(k.setFromMatrixColumn(t,0),k.crossVectors(this.object.up,k)),k.multiplyScalar(e),this._panOffset.add(k)}_pan(e,t){let n=this.domElement;if(this.object.isPerspectiveCamera){let r=this.object.position;k.copy(r).sub(this.target);let i=k.length();i*=Math.tan(this.object.fov/2*Math.PI/180),this._panLeft(2*e*i/n.clientHeight,this.object.matrix),this._panUp(2*t*i/n.clientHeight,this.object.matrix)}else this.object.isOrthographicCamera?(this._panLeft(e*(this.object.right-this.object.left)/this.object.zoom/n.clientWidth,this.object.matrix),this._panUp(t*(this.object.top-this.object.bottom)/this.object.zoom/n.clientHeight,this.object.matrix)):(console.warn(`WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.`),this.enablePan=!1)}_dollyOut(e){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale/=e:(console.warn(`WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled.`),this.enableZoom=!1)}_dollyIn(e){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale*=e:(console.warn(`WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled.`),this.enableZoom=!1)}_updateZoomParameters(e,t){if(!this.zoomToCursor)return;this._performCursorZoom=!0;let n=this.domElement.getBoundingClientRect(),r=e-n.left,i=t-n.top,a=n.width,o=n.height;this._mouse.x=r/a*2-1,this._mouse.y=-(i/o)*2+1,this._dollyDirection.set(this._mouse.x,this._mouse.y,1).unproject(this.object).sub(this.object.position).normalize()}_clampDistance(e){return Math.max(this.minDistance,Math.min(this.maxDistance,e))}_handleMouseDownRotate(e){this._rotateStart.set(e.clientX,e.clientY)}_handleMouseDownDolly(e){this._updateZoomParameters(e.clientX,e.clientX),this._dollyStart.set(e.clientX,e.clientY)}_handleMouseDownPan(e){this._panStart.set(e.clientX,e.clientY)}_handleMouseMoveRotate(e){this._rotateEnd.set(e.clientX,e.clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);let t=this.domElement;this._rotateLeft(A*this._rotateDelta.x/t.clientHeight),this._rotateUp(A*this._rotateDelta.y/t.clientHeight),this._rotateStart.copy(this._rotateEnd),this.update()}_handleMouseMoveDolly(e){this._dollyEnd.set(e.clientX,e.clientY),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),this._dollyDelta.y>0?this._dollyOut(this._getZoomScale(this._dollyDelta.y)):this._dollyDelta.y<0&&this._dollyIn(this._getZoomScale(this._dollyDelta.y)),this._dollyStart.copy(this._dollyEnd),this.update()}_handleMouseMovePan(e){this._panEnd.set(e.clientX,e.clientY),this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd),this.update()}_handleMouseWheel(e){this._updateZoomParameters(e.clientX,e.clientY),e.deltaY<0?this._dollyIn(this._getZoomScale(e.deltaY)):e.deltaY>0&&this._dollyOut(this._getZoomScale(e.deltaY)),this.update()}_handleKeyDown(e){let t=!1;switch(e.code){case this.keys.UP:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateUp(A*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(0,this.keyPanSpeed),t=!0;break;case this.keys.BOTTOM:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateUp(-A*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(0,-this.keyPanSpeed),t=!0;break;case this.keys.LEFT:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateLeft(A*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(this.keyPanSpeed,0),t=!0;break;case this.keys.RIGHT:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateLeft(-A*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(-this.keyPanSpeed,0),t=!0;break}t&&(e.preventDefault(),this.update())}_handleTouchStartRotate(e){if(this._pointers.length===1)this._rotateStart.set(e.pageX,e.pageY);else{let t=this._getSecondPointerPosition(e),n=.5*(e.pageX+t.x),r=.5*(e.pageY+t.y);this._rotateStart.set(n,r)}}_handleTouchStartPan(e){if(this._pointers.length===1)this._panStart.set(e.pageX,e.pageY);else{let t=this._getSecondPointerPosition(e),n=.5*(e.pageX+t.x),r=.5*(e.pageY+t.y);this._panStart.set(n,r)}}_handleTouchStartDolly(e){let t=this._getSecondPointerPosition(e),n=e.pageX-t.x,r=e.pageY-t.y,i=Math.sqrt(n*n+r*r);this._dollyStart.set(0,i)}_handleTouchStartDollyPan(e){this.enableZoom&&this._handleTouchStartDolly(e),this.enablePan&&this._handleTouchStartPan(e)}_handleTouchStartDollyRotate(e){this.enableZoom&&this._handleTouchStartDolly(e),this.enableRotate&&this._handleTouchStartRotate(e)}_handleTouchMoveRotate(e){if(this._pointers.length==1)this._rotateEnd.set(e.pageX,e.pageY);else{let t=this._getSecondPointerPosition(e),n=.5*(e.pageX+t.x),r=.5*(e.pageY+t.y);this._rotateEnd.set(n,r)}this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);let t=this.domElement;this._rotateLeft(A*this._rotateDelta.x/t.clientHeight),this._rotateUp(A*this._rotateDelta.y/t.clientHeight),this._rotateStart.copy(this._rotateEnd)}_handleTouchMovePan(e){if(this._pointers.length===1)this._panEnd.set(e.pageX,e.pageY);else{let t=this._getSecondPointerPosition(e),n=.5*(e.pageX+t.x),r=.5*(e.pageY+t.y);this._panEnd.set(n,r)}this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd)}_handleTouchMoveDolly(e){let t=this._getSecondPointerPosition(e),n=e.pageX-t.x,r=e.pageY-t.y,i=Math.sqrt(n*n+r*r);this._dollyEnd.set(0,i),this._dollyDelta.set(0,(this._dollyEnd.y/this._dollyStart.y)**+this.zoomSpeed),this._dollyOut(this._dollyDelta.y),this._dollyStart.copy(this._dollyEnd);let a=(e.pageX+t.x)*.5,o=(e.pageY+t.y)*.5;this._updateZoomParameters(a,o)}_handleTouchMoveDollyPan(e){this.enableZoom&&this._handleTouchMoveDolly(e),this.enablePan&&this._handleTouchMovePan(e)}_handleTouchMoveDollyRotate(e){this.enableZoom&&this._handleTouchMoveDolly(e),this.enableRotate&&this._handleTouchMoveRotate(e)}_addPointer(e){this._pointers.push(e.pointerId)}_removePointer(e){delete this._pointerPositions[e.pointerId];for(let t=0;t<this._pointers.length;t++)if(this._pointers[t]==e.pointerId){this._pointers.splice(t,1);return}}_isTrackingPointer(e){for(let t=0;t<this._pointers.length;t++)if(this._pointers[t]==e.pointerId)return!0;return!1}_trackPointer(e){let t=this._pointerPositions[e.pointerId];t===void 0&&(t=new x,this._pointerPositions[e.pointerId]=t),t.set(e.pageX,e.pageY)}_getSecondPointerPosition(e){let t=e.pointerId===this._pointers[0]?this._pointers[1]:this._pointers[0];return this._pointerPositions[t]}_customWheelEvent(e){let t=e.deltaMode,n={clientX:e.clientX,clientY:e.clientY,deltaY:e.deltaY};switch(t){case 1:n.deltaY*=16;break;case 2:n.deltaY*=100;break}return e.ctrlKey&&!this._controlActive&&(n.deltaY*=10),n}};function P(e){this.enabled!==!1&&(this._pointers.length===0&&(this.domElement.setPointerCapture(e.pointerId),this.domElement.addEventListener(`pointermove`,this._onPointerMove),this.domElement.addEventListener(`pointerup`,this._onPointerUp)),!this._isTrackingPointer(e)&&(this._addPointer(e),e.pointerType===`touch`?this._onTouchStart(e):this._onMouseDown(e)))}function F(e){this.enabled!==!1&&(e.pointerType===`touch`?this._onTouchMove(e):this._onMouseMove(e))}function I(e){switch(this._removePointer(e),this._pointers.length){case 0:this.domElement.releasePointerCapture(e.pointerId),this.domElement.removeEventListener(`pointermove`,this._onPointerMove),this.domElement.removeEventListener(`pointerup`,this._onPointerUp),this.dispatchEvent(T),this.state=j.NONE;break;case 1:let t=this._pointers[0],n=this._pointerPositions[t];this._onTouchStart({pointerId:t,pageX:n.x,pageY:n.y});break}}function L(e){let t;switch(e.button){case 0:t=this.mouseButtons.LEFT;break;case 1:t=this.mouseButtons.MIDDLE;break;case 2:t=this.mouseButtons.RIGHT;break;default:t=-1}switch(t){case s.DOLLY:if(this.enableZoom===!1)return;this._handleMouseDownDolly(e),this.state=j.DOLLY;break;case s.ROTATE:if(e.ctrlKey||e.metaKey||e.shiftKey){if(this.enablePan===!1)return;this._handleMouseDownPan(e),this.state=j.PAN}else{if(this.enableRotate===!1)return;this._handleMouseDownRotate(e),this.state=j.ROTATE}break;case s.PAN:if(e.ctrlKey||e.metaKey||e.shiftKey){if(this.enableRotate===!1)return;this._handleMouseDownRotate(e),this.state=j.ROTATE}else{if(this.enablePan===!1)return;this._handleMouseDownPan(e),this.state=j.PAN}break;default:this.state=j.NONE}this.state!==j.NONE&&this.dispatchEvent(w)}function R(e){switch(this.state){case j.ROTATE:if(this.enableRotate===!1)return;this._handleMouseMoveRotate(e);break;case j.DOLLY:if(this.enableZoom===!1)return;this._handleMouseMoveDolly(e);break;case j.PAN:if(this.enablePan===!1)return;this._handleMouseMovePan(e);break}}function z(e){this.enabled===!1||this.enableZoom===!1||this.state!==j.NONE||(e.preventDefault(),this.dispatchEvent(w),this._handleMouseWheel(this._customWheelEvent(e)),this.dispatchEvent(T))}function B(e){this.enabled!==!1&&this._handleKeyDown(e)}function V(t){switch(this._trackPointer(t),this._pointers.length){case 1:switch(this.touches.ONE){case e.ROTATE:if(this.enableRotate===!1)return;this._handleTouchStartRotate(t),this.state=j.TOUCH_ROTATE;break;case e.PAN:if(this.enablePan===!1)return;this._handleTouchStartPan(t),this.state=j.TOUCH_PAN;break;default:this.state=j.NONE}break;case 2:switch(this.touches.TWO){case e.DOLLY_PAN:if(this.enableZoom===!1&&this.enablePan===!1)return;this._handleTouchStartDollyPan(t),this.state=j.TOUCH_DOLLY_PAN;break;case e.DOLLY_ROTATE:if(this.enableZoom===!1&&this.enableRotate===!1)return;this._handleTouchStartDollyRotate(t),this.state=j.TOUCH_DOLLY_ROTATE;break;default:this.state=j.NONE}break;default:this.state=j.NONE}this.state!==j.NONE&&this.dispatchEvent(w)}function H(e){switch(this._trackPointer(e),this.state){case j.TOUCH_ROTATE:if(this.enableRotate===!1)return;this._handleTouchMoveRotate(e),this.update();break;case j.TOUCH_PAN:if(this.enablePan===!1)return;this._handleTouchMovePan(e),this.update();break;case j.TOUCH_DOLLY_PAN:if(this.enableZoom===!1&&this.enablePan===!1)return;this._handleTouchMoveDollyPan(e),this.update();break;case j.TOUCH_DOLLY_ROTATE:if(this.enableZoom===!1&&this.enableRotate===!1)return;this._handleTouchMoveDollyRotate(e),this.update();break;default:this.state=j.NONE}}function U(e){this.enabled!==!1&&e.preventDefault()}function W(e){e.key===`Control`&&(this._controlActive=!0,this.domElement.getRootNode().addEventListener(`keyup`,this._interceptControlUp,{passive:!0,capture:!0}))}function G(e){e.key===`Control`&&(this._controlActive=!1,this.domElement.getRootNode().removeEventListener(`keyup`,this._interceptControlUp,{passive:!0,capture:!0}))}var K=1024,q=Array.from({length:K},()=>Math.random()<.5),J=0,Y={select:e=>e[Math.floor(Math.random()*e.length)],binary:()=>{let e=q[J%K];return J=(J+1)%K,e},rand:()=>Math.random()},X=class{mesh;scene;x;y;z;state=null;marker=null;blank=null;base;active;constructor(e,t,n,r,i,a,o,s){this.scene=e,this.x=i,this.y=a,this.z=o,this.base=n,this.active=r,this.mesh=new f(t,n.clone()),this.mesh.position.set(i*(p.CELL_SIZE+p.GAP)-s,a*(p.CELL_SIZE+p.GAP)-s,o*(p.CELL_SIZE+p.GAP)-s),this.mesh.userData={gx:i,gy:a,gz:o,state:`empty`,marker:null,blank:null},this.addBlank(),this.scene.add(this.mesh)}hover(e){this.mesh.material=e?this.active:this.base}set(e,t){this.removeMarker(),this.removeBlank(),this.state=e,this.mesh.userData.state=e,this.marker=t,this.mesh.userData.marker=t,t.position.copy(this.mesh.position),t.userData.parentCell=this.mesh,this.scene.add(t),this.grow(t)}reset(){this.removeMarker(),this.state=null,this.mesh.userData.state=`empty`,this.addBlank()}addBlank(){if(this.blank)return;let e=v.blank(p.CELL_SIZE);e.position.copy(this.mesh.position),this.scene.add(e),this.blank=e,this.mesh.userData.blank=e}removeBlank(){this.blank&&(this.scene.remove(this.blank),this.blank=null,this.mesh.userData.blank=null)}removeMarker(){this.marker&&(this.scene.remove(this.marker),this.marker=null,this.mesh.userData.marker=null)}grow(e){e.scale.set(0,0,0);let t=0,n=()=>{t<1&&(t+=.1,e.scale.set(t,t,t),requestAnimationFrame(n))};n()}},Z=class{scene;cells=[];grid;markers=[];offset;geometry;material;hoverMat;constructor(e){this.scene=e,this.scene.background=new _(2951762),this.offset=(p.GRID_SIZE-1)*(p.CELL_SIZE+p.GAP)/2,this.geometry=new i(p.CELL_SIZE,p.CELL_SIZE,p.CELL_SIZE),this.material=new l({color:p.COLORS.cream,transparent:!0,opacity:p.OPACITY.CELL}),this.hoverMat=new l({color:p.COLORS.salmon,transparent:!0,opacity:p.OPACITY.HOVER}),this.grid=[];for(let e=0;e<p.GRID_SIZE;e++){this.grid[e]=[];for(let t=0;t<p.GRID_SIZE;t++){this.grid[e][t]=[];for(let n=0;n<p.GRID_SIZE;n++){let r=new X(this.scene,this.geometry,this.material,this.hoverMat,e,t,n,this.offset);this.grid[e][t][n]=r,this.cells.push(r.mesh)}}}}Cell(e,t,n){return this.grid[e][t][n].state}updateCells(e,t,n){let{gx:r,gy:i,gz:a}=e.userData,o=this.grid[r][i][a];if(t&&n)o.set(t,n),this.markers.push(n);else{let e=o.marker;o.reset(),e&&this.unmark(e)}}unmark(e){let t=this.markers.indexOf(e);t>=0&&this.markers.splice(t,1)}highlight(e){if(this.cells.forEach(e=>{let{gx:t,gy:n,gz:r}=e.userData;this.grid[t][n][r].hover(!1)}),e){let{gx:t,gy:n,gz:r}=e.userData;this.grid[t][n][r].hover(!0)}}},Q=class{board;scene;constructor(e,t){this.board=e,this.scene=t}valid(e,t){let n=e.userData.state;return n===`both`?!1:n===`empty`?!0:n===`x`&&t===`o`||n===`o`&&t===`x`}collect(e){let t=[],n=[],r=[];for(let i=0;i<e.length;i++){let a=e[i].userData;!a.collapsed&&[`_x`,`_o`,`_both`].includes(a.name)&&(a.name===`_x`?t.push(i):a.name===`_o`?n.push(i):r.push(i))}return{xs:t,os:n,bs:r,hasBoth:r.length>0}}collapse(e,t,n,r){for(let i of t){let t=e[i],a=t.userData.parentCell;if(!a)continue;let{gx:o,gy:s,gz:c}=a.userData,l=this.board.grid[o][s][c];if(n.has(i))t.userData.collapsed=!0,l.reset();else{let e;e=r&&r.has(i)?r.get(i):t.userData.name===`_x`?`x`:`o`;let n=(e===`x`?v.cross:v.sphere)(p.CELL_SIZE);n.rotation.copy(t.rotation),n.userData={name:e===`x`?`_x`:`_o`,collapsed:!0,parentCell:a},t.userData.isReplaced=!0,t.userData.replacement=n,l.set(e,n)}}}clean(e,t){let n=[];for(let r=0;r<e.length;r++){if(t.has(r))continue;let i=e[r];i.userData.isReplaced?n.push(i.userData.replacement):n.push(i)}this.board.markers=n}performCollapse(){let e=this.board.markers,{xs:t,os:n,bs:r,hasBoth:i}=this.collect(e);if(!t.length||!n.length)return;let a=Y.select(t),o=Y.select(n),s=Y.select(r),c=[...t,...n,...r],l=new Set(c),u=new Map,d=e=>l.delete(e);if(!i)d(a),d(o);else{let e=Y.rand();e<.25?(d(a),d(o)):e<.5?(d(a),d(s),u.set(s,`o`)):(d(o),d(s),u.set(s,`x`))}this.collapse(e,c,l,u),this.clean(e,l)}checkWin(){let e=this.board.grid,t=[],n=(e,t)=>{let n=t===`x`?e.state===`x`:e.state===`o`,r=e.marker?.userData?.collapsed;return n&&r};for(let e=0;e<3;e++)for(let n=0;n<3;n++)t.push([[0,e,n],[1,e,n],[2,e,n]]),t.push([[e,0,n],[e,1,n],[e,2,n]]),t.push([[e,n,0],[e,n,1],[e,n,2]]);for(let e=0;e<3;e++)t.push([[e,0,0],[e,1,1],[e,2,2]]),t.push([[e,0,2],[e,1,1],[e,2,0]]),t.push([[0,e,0],[1,e,1],[2,e,2]]),t.push([[2,e,0],[1,e,1],[0,e,2]]),t.push([[0,0,e],[1,1,e],[2,2,e]]),t.push([[2,0,e],[1,1,e],[0,2,e]]);t.push([[0,0,0],[1,1,1],[2,2,2]]),t.push([[2,0,0],[1,1,1],[0,2,2]]),t.push([[0,2,0],[1,1,1],[2,0,2]]),t.push([[0,0,2],[1,1,1],[2,2,0]]);for(let r of t){let[t,i,a]=r,o=e[t[0]][t[1]][t[2]],s=e[i[0]][i[1]][i[2]],c=e[a[0]][a[1]][a[2]];if(n(o,`x`)&&n(s,`x`)&&n(c,`x`))return{start:t,end:a,winner:`x`};if(n(o,`o`)&&n(s,`o`)&&n(c,`o`))return{start:t,end:a,winner:`o`}}return null}},te=document.getElementById(`turn-indicator`),$=document.getElementById(`status`),ne=class{scene;camera;renderer;controls;clock;raycaster;constructor(){this.scene=new S,this.scene.background=new _(2951762);let[e,t]=[window.innerWidth,window.innerHeight];this.camera=new c(75,e/t,.1,100),this.camera.position.set(8,8,10),this.renderer=new g({antialias:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(window.devicePixelRatio),document.body.appendChild(this.renderer.domElement);let n=new u(16777215,.6),r=new y(16777215,1);r.position.set(10,20,10),this.scene.add(n,r),this.controls=new N(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.minDistance=5,this.controls.maxDistance=30,this.clock=new m,this.raycaster=new a,window.addEventListener(`resize`,()=>this.onWindowResize())}onWindowResize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)}};new class{director;board;rules;currentPlayer=`x`;movesThisTurn=0;active=!0;mouse=new x;hoveredCell=null;constructor(){this.director=new ne,this.board=new Z(this.director.scene),this.rules=new Q(this.board,this.director.scene),this.setupInputs(),this.animate(),this.updateUI()}setupInputs(){window.addEventListener(`mousemove`,e=>this.onMouseMove(e)),window.addEventListener(`click`,()=>this.onClick())}onMouseMove(e){if(!this.active)return;this.mouse.x=e.clientX/window.innerWidth*2-1,this.mouse.y=-(e.clientY/window.innerHeight)*2+1,this.director.raycaster.setFromCamera(this.mouse,this.director.camera);let t=this.director.raycaster.intersectObjects(this.board.cells);if(this.hoveredCell&&=(this.board.highlight(null),null),t.length>0){let e=t[0].object;this.rules.valid(e,this.currentPlayer)&&(this.hoveredCell=e,this.board.highlight(e))}}onClick(){this.hoveredCell&&this.active&&(this.executeMove(this.hoveredCell),this.hoveredCell=null)}executeMove(e){let{gx:t,gy:n,gz:r}=e.userData,i=this.board.Cell(t,n,r),a=null,o=null;if(i===null)a=this.currentPlayer,o=this.currentPlayer===`x`?v.half_cross(p.CELL_SIZE):v.half_sphere(p.CELL_SIZE),o.userData={name:`_`+this.currentPlayer,collapsed:!1};else if(i===`x`&&this.currentPlayer===`o`||i===`o`&&this.currentPlayer===`x`)a=`both`,o=v.both(p.CELL_SIZE),o.userData={name:`_both`,collapsed:!1};else return;this.board.updateCells(e,a,o),this.movesThisTurn++,this.movesThisTurn>=2&&(this.movesThisTurn=0,this.currentPlayer=this.currentPlayer===`x`?`o`:`x`,this.currentPlayer===`x`&&this.rules.performCollapse());let s=this.rules.checkWin();if(s)return this.handleWin(s);this.updateUI()}handleWin(e){this.active=!1,$.innerText=`Player ${e.winner.toUpperCase()} Wins!`,$.style.color=`#00ff00`;let t=e=>{let t=p.CELL_SIZE+p.GAP,r=(p.GRID_SIZE-1)*t/2;return new n(e[0]*t-r,e[1]*t-r,e[2]*t-r)},r=t(e.start),i=t(e.end),a=new d(.1,.1,r.distanceTo(i),8);a.translate(0,r.distanceTo(i)/2,0),a.rotateX(Math.PI/2);let o=new f(a,new l({color:p.COLORS.coral,depthTest:!1}));o.position.copy(r),o.lookAt(i),this.director.scene.add(o)}updateUI(){te.innerText=`${this.currentPlayer===`x`?`X (Cross)`:`O (Sphere)`} â€” Move ${this.movesThisTurn+1}/2`}animate(){requestAnimationFrame(()=>this.animate());let e=this.director.clock.getDelta();for(let t of this.board.markers)t.rotation.y+=e*p.MOTION_SPEED;this.director.controls.update(),this.director.renderer.render(this.director.scene,this.director.camera)}};